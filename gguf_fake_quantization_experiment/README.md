# GGUF FFN Norm Fake Quantization å¯¦é©—

ä¸€å€‹ç”¨æ–¼ç ”ç©¶GGUFæ¨¡åž‹FFN normæ¬Šé‡BF16 fake quantizationæ•ˆæžœçš„å¯¦é©—é …ç›®ã€‚

## ðŸŽ¯ å¯¦é©—ç›®çš„

- é–‹ç™¼BF16 fake quantizationå·¥å…·
- åˆ†æžç¾ä»£GGUFæ¨¡åž‹çš„æ¬Šé‡ç²¾åº¦åˆ†å¸ƒ
- è©•ä¼°é‡åŒ–å°æ¨¡åž‹æ€§èƒ½çš„å½±éŸ¿
- å»ºç«‹å¯é‡ç¾çš„é‡åŒ–å¯¦é©—æµç¨‹

## ðŸ” ä¸»è¦ç™¼ç¾

### é—œéµæ´žå¯Ÿ
âœ… **ç¾ä»£GGUFæ¨¡åž‹çš„normæ¬Šé‡å·²ç¶“è¢«å„ªåŒ–ç‚ºBF16ç²¾åº¦**  
âœ… **Fake quantizationå·¥å…·å¯¦ç¾æ­£ç¢ºï¼Œæ–¹æ³•å¯é **  
âœ… **å»ºç«‹äº†å®Œæ•´çš„æ¬Šé‡ç²¾åº¦åˆ†æžæµç¨‹**  

### å¯¦é©—çµæžœ
- **TinyLlama 1.1B**: æ‰€æœ‰F32 normæ¬Šé‡éƒ½æ˜¯BF16ç²¾åº¦ï¼Œfake quantizationç„¡æ•ˆæžœ
- **Llama-3.2 1B**: é©—è­‰äº†å·¥å…·æ­£ç¢ºæ€§ï¼Œrope_freqs.weightç”¢ç”Ÿå¯æ¸¬é‡çš„é‡åŒ–æ•ˆæžœ
- **Perplexityæ¸¬è©¦**: åœ¨BF16ç²¾åº¦æ¬Šé‡ä¸Šç„¡è®ŠåŒ–ï¼ˆé æœŸçµæžœï¼‰

## ðŸ›  å·¥å…·èˆ‡æ–¹æ³•

### æ ¸å¿ƒå·¥å…·
- **fake_quantize_gguf.py**: ä¸»è¦çš„BF16 fake quantizationå·¥å…·
- **ç²¾åº¦åˆ†æžè…³æœ¬**: æª¢æŸ¥æ¬Šé‡çš„ä½Ž16ä½åˆ†å¸ƒ
- **æ¨¡åž‹æ¯”è¼ƒå·¥å…·**: å°æ¯”é‡åŒ–å‰å¾Œçš„æ¨¡åž‹æ•ˆæžœ

### é‡åŒ–ç®—æ³•
```python
def fake_quantize_to_bf16(tensor_f32):
    """BF16 fake quantization: ä¿ç•™é«˜16ä½ï¼Œæ¸…é›¶ä½Ž16ä½"""
    f32_bits = tensor_f32.astype(np.float32).view(np.uint32)
    bf16_bits = (f32_bits >> 16) << 16
    return bf16_bits.view(np.float32)
```

## ðŸ“ é …ç›®çµæ§‹

```
gguf_fake_quantization_experiment/
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ fake_quantize_gguf.py          # ä¸»è¦é‡åŒ–å·¥å…·
â”œâ”€â”€ data/                              # æ¸¬è©¦æ¨¡åž‹å’Œæ•¸æ“š
â”œâ”€â”€ results/                           # å¯¦é©—çµæžœå’Œåˆ†æž
â”œâ”€â”€ docs/                              # å¯¦é©—è¨ˆåŠƒå’Œæ–‡æª”
â”œâ”€â”€ logs/                              # å‘½ä»¤è¨˜éŒ„å’Œæ—¥èªŒ
â”œâ”€â”€ FFN_NORM_FAKE_QUANTIZATION_FINAL_REPORT.md  # æœ€çµ‚å ±å‘Š
â””â”€â”€ README.md                          # æœ¬æ–‡ä»¶
```

## ðŸš€ å¿«é€Ÿé–‹å§‹

### ç’°å¢ƒæº–å‚™
```bash
# ç¢ºä¿å·²å®‰è£llama.cppå’Œgguf-py
git clone https://github.com/ggerganov/llama.cpp.git
cd llama.cpp
make

# å®‰è£Pythonä¾è³´
pip install numpy
```

### é‹è¡Œå¯¦é©—
```bash
# é€²å…¥å¯¦é©—ç›®éŒ„
cd gguf_fake_quantization_experiment

# é‹è¡Œfake quantizationï¼ˆä½¿ç”¨é»˜èªåƒæ•¸ï¼‰
python scripts/fake_quantize_gguf.py --verbose

# æª¢æŸ¥æ¬Šé‡ç²¾åº¦åˆ†å¸ƒ
python check_f32_norms.py
```

### è‡ªå®šç¾©æ¸¬è©¦
```bash
# æŒ‡å®šè¼¸å…¥å’Œè¼¸å‡ºæ¨¡åž‹
python scripts/fake_quantize_gguf.py input.gguf output.gguf --layers "0,1,2" --verbose

# æ¸¬è©¦ä¸åŒå±¤
python scripts/fake_quantize_gguf.py input.gguf output.gguf --layers "5,10,15" --verbose
```

## ðŸ“Š å¯¦é©—çµæžœç¤ºä¾‹

### TinyLlamaæ¨¡åž‹æ¸¬è©¦
```
Layer 0 FFN normæ¬Šé‡:
- æ•¸å€¼å·®ç•°: 0.00% (å·²æ˜¯BF16ç²¾åº¦)
- Perplexity: 15.9228 (ç„¡è®ŠåŒ–)
- å°è©±è³ªé‡: å®Œå…¨ä¸€è‡´
```

### Llama-3.2æ¨¡åž‹é©—è­‰
```
rope_freqs.weight:
- æœ€å¤§çµ•å°å·®ç•°: 4.17e-02
- å¹³å‡çµ•å°å·®ç•°: 1.74e-03
- æœ€å¤§ç›¸å°å·®ç•°: 0.43%
âœ… è­‰æ˜Žå·¥å…·æ­£ç¢ºæ€§
```

## ðŸ“– è©³ç´°æ–‡æª”

- [æœ€çµ‚å¯¦é©—å ±å‘Š](FFN_NORM_FAKE_QUANTIZATION_FINAL_REPORT.md) - å®Œæ•´çš„å¯¦é©—çµæžœå’Œåˆ†æž
- [å‘½ä»¤æ­·å²è¨˜éŒ„](logs/command_history.md) - æ‰€æœ‰åŸ·è¡Œå‘½ä»¤çš„è©³ç´°è¨˜éŒ„
- [å¯¦é©—è¨ˆåŠƒ](docs/experiment_plan.md) - åŽŸå§‹å¯¦é©—è¨­è¨ˆ
- [ç²¾åº¦åˆ†æžå ±å‘Š](results/layer0/precision_analysis_report.md) - æ¬Šé‡ç²¾åº¦åˆ†å¸ƒåˆ†æž

## ðŸ”¬ æŠ€è¡“ç´°ç¯€

### BF16 Fake QuantizationåŽŸç†
1. **è®€å–F32æ¬Šé‡**: è¼‰å…¥32ä½æµ®é»žæ•¸æ¬Šé‡
2. **ä½æ“ä½œè½‰æ›**: ä¿ç•™é«˜16ä½ï¼ˆç¬¦è™Ÿ+æŒ‡æ•¸+é«˜7ä½å°¾æ•¸ï¼‰ï¼Œæ¸…é›¶ä½Ž16ä½
3. **ä¿æŒF32æ ¼å¼**: è½‰æ›å¾Œä»ä»¥F32æ ¼å¼å„²å­˜ï¼Œä½†ç²¾åº¦ç­‰åŒBF16
4. **æ•ˆæžœåˆ†æž**: è¨ˆç®—é‡åŒ–å‰å¾Œçš„æ•¸å€¼å·®ç•°

### æ¬Šé‡ç²¾åº¦æª¢æ¸¬
```python
# æª¢æŸ¥æ¬Šé‡æ˜¯å¦ç‚ºBF16ç²¾åº¦
bits = tensor.view(np.uint32)
low_16_bits = bits & 0xFFFF
bf16_ratio = np.count_nonzero(low_16_bits == 0) / tensor.size
```

## ðŸŽ¯ ç ”ç©¶åƒ¹å€¼

### æŠ€è¡“è²¢ç»
- **é‡åŒ–å·¥å…·**: æä¾›é€šç”¨çš„fake quantizationå¯¦ç¾
- **åˆ†æžæ–¹æ³•**: å»ºç«‹æ¬Šé‡ç²¾åº¦åˆ†æžæ¨™æº–æµç¨‹
- **æ¨¡åž‹æ´žå¯Ÿ**: æ­ç¤ºç¾ä»£GGUFæ¨¡åž‹çš„ç²¾åº¦å„ªåŒ–ç­–ç•¥

### å¯¦éš›æ‡‰ç”¨
- **æ¨¡åž‹ç†è§£**: å¹«åŠ©ç†è§£é‡åŒ–æ¨¡åž‹çš„å…§åœ¨ç‰¹æ€§
- **ç ”ç©¶åŸºç¤Ž**: ç‚ºé€²ä¸€æ­¥çš„é‡åŒ–ç ”ç©¶æä¾›å·¥å…·å’Œæ–¹æ³•
- **æ€§èƒ½åˆ†æž**: è©•ä¼°ä¸åŒç²¾åº¦å°æ¨¡åž‹æ€§èƒ½çš„å½±éŸ¿

## ðŸ”® å¾ŒçºŒæ–¹å‘

### å»ºè­°çš„æ“´å±•å¯¦é©—
- [ ] æ¸¬è©¦æ›´å¤šæ¨¡åž‹æž¶æ§‹å’Œå¤§å°
- [ ] å¯¦ç¾INT8ã€4-bitç­‰å…¶ä»–é‡åŒ–æ–¹æ³•
- [ ] ç³»çµ±æ€§åˆ†æžä¸åŒå±¤çš„é‡åŒ–æ•æ„Ÿæ€§
- [ ] é–‹ç™¼è‡ªå‹•åŒ–çš„æœ€å„ªé‡åŒ–ç­–ç•¥

### å·¥å…·æ”¹é€²
- [ ] æ”¯æ´æ›´å¤šæ¬Šé‡é¡žåž‹çš„é‡åŒ–
- [ ] æ·»åŠ é‡åŒ–æ•ˆæžœçš„è‡ªå‹•è©•ä¼°
- [ ] é–‹ç™¼GUIç•Œé¢
- [ ] å„ªåŒ–å¤§æ¨¡åž‹çš„è™•ç†æ€§èƒ½

## ðŸ“„ è¨±å¯è­‰

æœ¬é …ç›®æŽ¡ç”¨èˆ‡llama.cppç›¸åŒçš„è¨±å¯è­‰ã€‚

## ðŸ¤ è²¢ç»

æ­¡è¿Žæäº¤Issueå’ŒPull Requestï¼

## ðŸ“§ è¯ç¹«

å¦‚æœ‰å•é¡Œæˆ–å»ºè­°ï¼Œè«‹é€šéŽGitHub Issuesè¯ç¹«ã€‚

---

**å¯¦é©—ç‹€æ…‹**: âœ… å®Œæˆ  
**æœ€å¾Œæ›´æ–°**: 2025-07-15  
**æŠ€è¡“é©—è­‰**: âœ… å·¥å…·æ­£ç¢ºï¼Œæ–¹æ³•å¯é 